<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‘ªåˆ©æ­æ´¾å°ï¼šæ™‚é–“å¤§å†’éšª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Noto+Sans+TC:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            background-color: #5c94fc;
            background-image: 
                radial-gradient(white 15%, transparent 16%),
                radial-gradient(white 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* ç¦æ­¢æ²å‹• */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* éŠæˆ²å¡ç‰‡ */
        .game-card {
            background: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 0 #e2e8f0, 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            border: 6px solid #ffd700;
            position: relative;
            overflow: hidden;
            width: 95%;
            max-width: 480px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }

        .mario-btn {
            background: linear-gradient(to bottom, #ff5e57, #ff3b30);
            color: white;
            border: 3px solid #c0392b;
            border-radius: 0.8rem;
            box-shadow: 0 4px 0 #922b21;
            transition: all 0.1s;
        }
        .mario-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #922b21;
        }

        .option-btn {
            background: #fff;
            border: 3px solid #8e44ad;
            color: #2c3e50;
            border-radius: 0.8rem;
            box-shadow: 0 4px 0 #5b2c6f;
            transition: all 0.1s;
            position: relative;
        }
        .option-btn:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 #5b2c6f;
        }
        
        .btn-correct { background: #2ecc71 !important; border-color: #27ae60 !important; color: white !important; box-shadow: 0 4px 0 #1e8449 !important; }
        .btn-wrong { background: #e74c3c !important; border-color: #c0392b !important; color: white !important; box-shadow: 0 4px 0 #922b21 !important; }

        .cloud {
            position: absolute; background: white; border-radius: 50px; opacity: 0.8; z-index: 0;
            animation: floatCloud 25s linear infinite;
        }
        @keyframes floatCloud { from { transform: translateX(-100px); } to { transform: translateX(100vw); } }

        @keyframes countdown { from { width: 100%; background: #2ecc71; } 50% { background: #f1c40f; } to { width: 0%; background: #e74c3c; } }
        .timer-running { animation: countdown linear forwards; }

        .bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .coin-spin { animation: spin 0.5s linear; }
        @keyframes spin { 100% { transform: rotateY(360deg); } }

        .sound-toggle {
            position: absolute; top: 8px; right: 8px; z-index: 50;
            background: #2c3e50; padding: 6px; border-radius: 50%; cursor: pointer; color: white; border: 2px solid white;
            transform: scale(0.9);
        }
        
        /* é›™æ™‚é˜ä½ˆå±€ */
        .clock-wrapper {
            position: relative; background: #22c55e; padding: 5px; border-radius: 50%; border: 3px solid #15803d;
        }
        .clock-bg { background: white; border-radius: 50%; border: 2px solid black; }
        
        .arrow-right {
            font-size: 1.5rem; color: #f59e0b; font-weight: 900; animation: pulse 1s infinite; margin: 0 5px;
        }
    </style>
</head>
<body>

    <div class="cloud w-32 h-12 top-5 left-0"></div>
    <div class="cloud w-24 h-10 bottom-10 right-10" style="animation-duration: 30s;"></div>

    <div class="game-card z-10">
        
        <!-- éŸ³æ•ˆé–‹é—œ -->
        <div id="sound-btn" class="sound-toggle" onclick="toggleMute()" title="é–‹é—œè²éŸ³">
            <i data-lucide="volume-2" id="sound-icon" class="w-5 h-5"></i>
        </div>

        <!-- é ‚éƒ¨è³‡è¨Š -->
        <div class="header-bar bg-gray-800 p-2 flex justify-between items-center border-b-4 border-gray-900 shrink-0">
            <div class="flex items-center gap-2">
                <div class="relative w-8 h-8">
                    <div class="absolute inset-0 bg-yellow-400 rounded-full border-2 border-yellow-600 shadow-inner flex items-center justify-center">
                        <div class="w-1 h-4 bg-yellow-600 opacity-30 rounded-full"></div>
                    </div>
                </div>
                <div class="text-white font-black text-xl tracking-widest leading-none">
                    <span class="text-[10px] text-yellow-400 block">é‡‘å¹£</span>
                    <span id="score">00</span>
                </div>
            </div>
            <div class="px-3 py-0.5 bg-blue-600 rounded-full border-2 border-blue-400 text-white font-bold text-xs shadow-lg transform -skew-x-12">
                é—œå¡ <span id="level-display">1-1</span>
            </div>
        </div>

        <!-- è¨ˆæ™‚æ¢ -->
        <div class="h-3 bg-gray-200 w-full relative border-b-4 border-gray-300 shrink-0">
            <div id="timer-bar" class="h-full bg-green-500 w-full"></div>
            <div id="timer-bomb" class="absolute top-1/2 -translate-y-1/2 -ml-2 transition-all duration-100" style="left: 100%">
                <i data-lucide="bomb" class="w-5 h-5 text-black fill-current drop-shadow-md"></i>
            </div>
        </div>

        <!-- éŠæˆ²ä¸»è¦å…§å®¹å€ -->
        <div id="game-container" class="p-3 sm:p-4 text-center relative flex flex-col justify-center flex-1 h-full">
            
            <!-- æ¨™ç±¤ -->
            <div class="mb-1 shrink-0">
                <span id="q-tag" class="px-3 py-0.5 bg-pink-500 text-white text-sm font-bold rounded-lg border-b-2 border-pink-700 shadow-sm">
                    æº–å‚™å¥½äº†å—ï¼Ÿ
                </span>
            </div>

            <!-- æ™‚é˜é¡¯ç¤ºå€ -->
            <div id="clocks-area" class="flex justify-center mb-2 items-center shrink-0 min-h-[130px]">
                <div class="clock-wrapper bounce-in">
                    <canvas id="mainClock" width="120" height="120" class="clock-bg"></canvas>
                </div>
            </div>

            <!-- é¡Œç›®æ–‡å­— -->
            <div class="bg-blue-50 px-3 py-2 rounded-lg border-2 border-blue-200 mb-3 flex items-center justify-center shrink-0 min-h-[4rem]">
                <h2 id="q-text" class="text-lg sm:text-xl font-bold text-gray-800 leading-snug">
                    æº–å‚™å¥½å°±æŒ‰ä¸‹é–‹å§‹ï¼<br>
                    <span class="text-xs font-normal text-gray-500">(è¨˜å¾—é–‹è²éŸ³å–”)</span>
                </h2>
            </div>

            <!-- é¸é … -->
            <div id="options-grid" class="grid grid-cols-2 gap-2 sm:gap-3 w-full shrink-0">
                <button onclick="initAndStart()" class="col-span-2 mario-btn py-3 text-xl font-black tracking-wider animate-pulse">
                    é–‹å§‹éŠæˆ² GO!
                </button>
            </div>
        </div>

        <!-- çµç®—ç•«é¢ -->
        <div id="result-screen" class="hidden absolute inset-0 bg-black/90 z-20 flex flex-col items-center justify-center text-white p-6">
            <h2 class="text-3xl font-black text-yellow-400 mb-1 drop-shadow-[0_4px_0_rgba(0,0,0,1)]">æ™‚é–“åˆ°ï¼</h2>
            <div class="text-lg mb-4 font-bold text-gray-300">å†’éšªçµæŸ</div>
            
            <div class="flex gap-2 mb-6">
                <i data-lucide="star" id="star-1" class="w-10 h-10 text-gray-600 fill-current transition-all"></i>
                <i data-lucide="star" id="star-2" class="w-14 h-14 text-gray-600 fill-current mb-2 transition-all delay-100"></i>
                <i data-lucide="star" id="star-3" class="w-10 h-10 text-gray-600 fill-current transition-all delay-200"></i>
            </div>

            <p class="text-base text-gray-400">ç²å¾—é‡‘å¹£</p>
            <div class="text-5xl font-black text-yellow-400 mb-8 coin-spin">
                <span id="final-coins">0</span>
            </div>

            <button onclick="initAndStart()" class="mario-btn px-8 py-3 text-lg font-bold w-full max-w-xs">
                å†ç©ä¸€æ¬¡
            </button>
        </div>
    </div>

    <!-- è…³æœ¬ -->
    <script>
        lucide.createIcons();

        // --- éŸ³æ•ˆ ---
        const AudioController = {
            ctx: null, isMuted: false,
            async init() {
                if (!this.ctx) { try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { return; } }
                if (this.ctx.state === 'suspended') await this.ctx.resume();
            },
            playTone(freq, type, duration, vol = 0.3) {
                if (this.isMuted || !this.ctx) return;
                try {
                    const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                    osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                    gain.gain.setValueAtTime(vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    osc.start(); osc.stop(this.ctx.currentTime + duration);
                } catch(e){}
            },
            playTick(isUrgent=false) { isUrgent ? this.playTone(800, 'square', 0.1, 0.3) : this.playTone(600, 'sine', 0.05, 0.2); },
            playCoin() { if(this.isMuted||!this.ctx)return; this.playTone(987, 'square', 0.1, 0.3); setTimeout(()=>this.playTone(1318, 'square', 0.4, 0.3),80); },
            playWrong() { this.playTone(150, 'sawtooth', 0.4, 0.4); },
            playStart() { if(this.isMuted||!this.ctx)return; [523,659,783,1046].forEach((n,i)=>setTimeout(()=>this.playTone(n,'triangle',0.2,0.3),i*120)); },
            playTimeUp() { if(this.isMuted||!this.ctx)return; this.playTone(200, 'sawtooth', 0.5, 0.5); }
        };

        async function toggleMute() {
            await AudioController.init();
            AudioController.isMuted = !AudioController.isMuted;
            const icon = document.getElementById('sound-icon');
            const btn = document.getElementById('sound-btn');
            if (AudioController.isMuted) { icon.setAttribute('data-lucide', 'volume-x'); btn.style.background = '#e74c3c'; } 
            else { icon.setAttribute('data-lucide', 'volume-2'); btn.style.background = '#2c3e50'; AudioController.playCoin(); }
            lucide.createIcons();
        }
        async function initAndStart() { await AudioController.init(); startGame(); }

        // --- é¡Œåº«é‚è¼¯ ---
        const CHARS = ["ç‘ªåˆ©æ­", "è·¯æ˜“å‰", "å…¬ä¸»", "è€€è¥¿", "å¥‡è«¾æ¯”å¥§"];
        function getRandomTime() {
            let h = Math.floor(Math.random()*12)+1;
            let m = Math.random()<0.4?0:(Math.random()<0.8?30:(Math.random()<0.9?15:45));
            return {h,m};
        }
        function addTime(t, mins) {
            let total = t.h*60 + t.m + mins;
            let newH = Math.floor(total/60); let newM = total%60;
            while(newH>12) newH-=12; if(newH===0) newH=12;
            return {h:newH, m:newM};
        }
        function formatTime(t) { return `${t.h}:${t.m.toString().padStart(2,'0')}`; }
        function formatDuration(m) {
            if(m===60) return "1å°æ™‚"; if(m===30) return "30åˆ†"; if(m===90) return "1å°æ™‚åŠ"; if(m===120) return "2å°æ™‚";
            return `${m}åˆ†`;
        }

        function generateQuestion() {
            const type = Math.floor(Math.random()*3);
            let qData = { type, text:"", correct:"", options:[], tag:"", clock1:null, clock2:null };
            const char = CHARS[Math.floor(Math.random()*CHARS.length)];
            const time1 = getRandomTime();
            const durations = [30,60,60,120,30,90];
            const duration = durations[Math.floor(Math.random()*durations.length)];
            const time2 = addTime(time1, duration);

            if (type===0) {
                qData.tag = "â° ç¾åœ¨å¹¾é»ï¼Ÿ";
                qData.text = "è«‹çœ‹ä¸Šé¢çš„æ™‚é˜ï¼Œ\næ˜¯å¹¾é»å¹¾åˆ†å‘¢ï¼Ÿ";
                qData.clock1 = time1;
                qData.correct = formatTime(time1);
                qData.options = generateOptions(qData.correct, false);
            } else if (type===1) {
                qData.tag = "â³ ç¶“éå¤šä¹…ï¼Ÿ";
                qData.text = "å¾å·¦é‚Šèµ°åˆ°å³é‚Šï¼Œ\néäº†å¤šä¹…æ™‚é–“ï¼Ÿ";
                qData.clock1 = time1; qData.clock2 = time2;
                qData.correct = formatDuration(duration);
                qData.options = generateOptions(qData.correct, true);
            } else {
                qData.tag = "ğŸ“ æƒ³ä¸€æƒ³";
                if(Math.random()>0.5) {
                    qData.text = `${char} ${formatTime(time1)} é–‹å§‹å¯«åŠŸèª²ï¼Œ\nå¯«äº†ã€Œ${formatDuration(duration)}ã€ã€‚\nå¹¾é»å¯«å®Œï¼Ÿ`;
                    qData.clock1 = time1;
                    qData.correct = formatTime(time2);
                    qData.options = generateOptions(qData.correct, false);
                } else {
                    qData.text = `${char} ${formatTime(time1)} å‡ºé–€ï¼Œ\n${formatTime(time2)} åˆ°é”åŸå ¡ã€‚\nèŠ±äº†å¤šä¹…ï¼Ÿ`;
                    qData.clock1 = time1;
                    qData.correct = formatDuration(duration);
                    qData.options = generateOptions(qData.correct, true);
                }
            }
            return qData;
        }

        function generateOptions(correct, isDuration) {
            let opts = [correct];
            while(opts.length<4) {
                let fake;
                if(isDuration) {
                    const fm = [30,60,90,120,15][Math.floor(Math.random()*5)];
                    fake = formatDuration(fm);
                } else {
                    let h = Math.floor(Math.random()*12)+1;
                    let m = [0,15,30,45][Math.floor(Math.random()*4)];
                    fake = `${h}:${m.toString().padStart(2,'0')}`;
                }
                if(!opts.includes(fake)) opts.push(fake);
            }
            return opts.sort(()=>Math.random()-0.5);
        }

        // --- éŠæˆ²æµç¨‹ ---
        const GAME_CONFIG = { totalQuestions: 5, timePerQuestion: 60 };
        let gameState = { currentQ: 0, score: 0, timer: null, currentData: null };
        const timerBar = document.getElementById('timer-bar');
        const timerBomb = document.getElementById('timer-bomb');

        function startGame() {
            AudioController.playStart();
            gameState.currentQ = 0; gameState.score = 0;
            document.getElementById('score').innerText = "00";
            document.getElementById('result-screen').classList.add('hidden');
            nextLevel();
        }

        function nextLevel() {
            if(gameState.currentQ >= GAME_CONFIG.totalQuestions) { showResults(); return; }
            gameState.currentQ++;
            document.getElementById('level-display').innerText = `${gameState.currentQ}/${GAME_CONFIG.totalQuestions}`;
            gameState.currentData = generateQuestion();
            renderQuestion(gameState.currentData);
            startTimer();
        }

        function renderQuestion(data) {
            document.getElementById('q-tag').innerText = data.tag;
            document.getElementById('q-text').innerHTML = data.text.replace(/\n/g, "<br>");
            
            const area = document.getElementById('clocks-area');
            area.innerHTML = '';
            
            const size = 110; 
            
            if(data.clock2) {
                area.innerHTML = `
                    <div class="flex flex-col items-center bounce-in">
                        <div class="clock-wrapper mb-0.5">
                            <canvas id="c1" width="${size}" height="${size}" class="clock-bg"></canvas>
                        </div>
                    </div>
                    <div class="arrow-right">âœ</div>
                    <div class="flex flex-col items-center bounce-in" style="animation-delay: 0.1s">
                        <div class="clock-wrapper mb-0.5">
                            <canvas id="c2" width="${size}" height="${size}" class="clock-bg"></canvas>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    drawClock(document.getElementById('c1'), data.clock1.h, data.clock1.m, size);
                    drawClock(document.getElementById('c2'), data.clock2.h, data.clock2.m, size);
                }, 10);
            } else {
                area.innerHTML = `
                    <div class="clock-wrapper bounce-in">
                        <canvas id="c1" width="${size+20}" height="${size+20}" class="clock-bg"></canvas>
                    </div>
                `;
                setTimeout(() => {
                    drawClock(document.getElementById('c1'), data.clock1.h, data.clock1.m, size+20);
                }, 10);
            }

            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "option-btn text-xl font-bold py-3 w-full";
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt, btn);
                grid.appendChild(btn);
            });
        }

        function startTimer() {
            if(gameState.timer) clearInterval(gameState.timer);
            timerBar.style.animation = 'none'; timerBar.offsetHeight;
            timerBar.style.animation = `countdown ${GAME_CONFIG.timePerQuestion}s linear forwards`;
            
            let timeLeft = GAME_CONFIG.timePerQuestion;
            let urgentTickTime = 0;
            const updateRate = 100;

            gameState.timer = setInterval(() => {
                timeLeft -= (updateRate/1000);
                if (timeLeft <= 10 && timeLeft > 0) {
                    urgentTickTime += updateRate;
                    if (timeLeft <= 5 && urgentTickTime >= 500) {
                        AudioController.playTick(true); urgentTickTime = 0;
                    } else if (timeLeft > 5 && urgentTickTime >= 1000) {
                        AudioController.playTick(false); urgentTickTime = 0;
                    }
                }
                const percent = (timeLeft / GAME_CONFIG.timePerQuestion) * 100;
                timerBomb.style.left = `${Math.max(0, percent)}%`;
                if (timeLeft <= 0) { clearInterval(gameState.timer); handleTimeUp(); }
            }, updateRate);
        }

        function handleTimeUp() {
            AudioController.playTimeUp();
            document.querySelector('.game-card').classList.add('scale-95');
            setTimeout(() => document.querySelector('.game-card').classList.remove('scale-95'), 200);
            disableBtns(); setTimeout(nextLevel, 2500);
        }

        function checkAnswer(selected, btn) {
            clearInterval(gameState.timer);
            timerBar.style.animationPlayState = 'paused';
            const isCorrect = selected === gameState.currentData.correct;
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.disabled = true);

            if(isCorrect) {
                AudioController.playCoin(); btn.classList.add('btn-correct');
                playCoinAnim(); gameState.score += 20;
                document.getElementById('score').innerText = gameState.score.toString().padStart(2, '0');
            } else {
                AudioController.playWrong(); btn.classList.add('btn-wrong');
                allBtns.forEach(b => { if(b.innerText === gameState.currentData.correct) b.classList.add('btn-correct'); });
            }
            setTimeout(nextLevel, 1500);
        }

        function disableBtns() {
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach(b => {
                b.disabled = true;
                if(b.innerText === gameState.currentData.correct) b.classList.add('btn-correct');
                else b.classList.add('opacity-50');
            });
        }

        function showResults() {
            AudioController.playStart();
            document.getElementById('result-screen').classList.remove('hidden');
            const finalCoins = document.getElementById('final-coins');
            let cur = 0; const target = gameState.score;
            if(target===0) finalCoins.innerText = 0;
            else {
                const interval = setInterval(() => {
                    if(cur>=target) clearInterval(interval); else { cur++; finalCoins.innerText = cur; }
                }, 30);
            }
            const stars = [document.getElementById('star-1'), document.getElementById('star-2'), document.getElementById('star-3')];
            if(target>0) stars[0].classList.replace('text-gray-600', 'text-yellow-400');
            if(target>=60) stars[1].classList.replace('text-gray-600', 'text-yellow-400');
            if(target===100) stars[2].classList.replace('text-gray-600', 'text-yellow-400');
        }
        function playCoinAnim() { const el = document.getElementById('score'); el.classList.remove('coin-spin'); void el.offsetWidth; el.classList.add('coin-spin'); }

        // --- ç¹ªåœ– ---
        function drawClock(cvs, h, m, size) {
            if(!cvs) return;
            const ctx = cvs.getContext('2d');
            const w = size; 
            const cx = w/2, cy = w/2, r = w/2 - 5;
            
            ctx.clearRect(0,0,w,w);
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, 2*Math.PI);
            ctx.fillStyle = '#fff'; ctx.fill();
            
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.font = `bold ${w/7}px Fredoka`;
            ctx.fillStyle = '#333';
            for(let i=1; i<=12; i++){
                const ang = (i*30-90)*Math.PI/180;
                ctx.fillText(i, cx+(r*0.8)*Math.cos(ang), cy+(r*0.8)*Math.sin(ang));
            }
            const mA = (m*6-90)*Math.PI/180;
            const hA = ((h%12)*30 + m*0.5 - 90)*Math.PI/180;
            drawHand(ctx, cx, cy, mA, r*0.85, 4, '#3b82f6');
            drawHand(ctx, cx, cy, hA, r*0.55, 6, '#ef4444');
            ctx.beginPath(); ctx.arc(cx, cy, 4, 0, 2*Math.PI); ctx.fillStyle = '#f59e0b'; ctx.fill();
        }
        function drawHand(ctx, x, y, ang, len, wid, color) {
            ctx.beginPath(); ctx.lineWidth = wid; ctx.lineCap = 'round';
            ctx.strokeStyle = color; ctx.moveTo(x, y); ctx.lineTo(x+len*Math.cos(ang), y+len*Math.sin(ang)); ctx.stroke();
        }

        window.onload = () => { drawClock(document.getElementById('mainClock'), 3, 0, 120); };
    </script>
</body>
</html>
